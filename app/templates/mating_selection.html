{% extends 'base.html' %}
{% block title %}Párosítási Csoportok Kiválasztása{% endblock %}

{% block content %}
<style>
    .selection-container { display: flex; justify-content: space-between; gap: 2rem; }
    .column { flex: 1; display: flex; flex-direction: column; }
    .animal-list { 
        border: 1px solid #ccc; 
        border-radius: var(--border-radius); 
        height: 300px; 
        overflow-y: auto; 
        padding: 0.5rem; 
        background: #f9f9f9;
    }
    .animal-list option { padding: 5px; border-bottom: 1px solid #eee; cursor: pointer; }
    .animal-list option:hover { background-color: #e9e9e9; }
    .controls { display: flex; flex-direction: column; justify-content: center; gap: 1rem; padding: 0 1rem; }
    .controls .button { width: 100%; }
    .farm-selector { margin-bottom: 1rem; padding: 10px; border-radius: var(--border-radius); border: 1px solid #ccc; }
    .main-actions { text-align: center; margin-top: 2rem;}

    /* Table styles for selected animals */
    .sortable-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        height: 300px; /* Match height of lists */
        display: block;
        overflow-y: auto;
    }
    .sortable-table thead, .sortable-table tbody tr { display: table; width: 100%; table-layout: fixed; }
    .sortable-table th, .sortable-table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
    }
    .sortable-table th {
        background-color: #f2f2f2;
        cursor: pointer;
        position: sticky; top: 0; /* Make header sticky */
    }
    .sortable-table th::after {
        content: ' \2195';
        font-size: 0.8em;
        opacity: 0.5;
        position: absolute;
        right: 8px;
    }
    .sortable-table tbody tr:hover { background-color: #f1f1f1; }
    .sortable-table tbody tr.selected { background-color: #cfe2ff; }

</style>

<h1>Párosítási Csoportok Összeállítása</h1>
<p>Válassza ki a tenyészetet, majd a listából a párosítási programba bevonni kívánt nőstény (dam) és hím (sire) egyedeket.</p>

<form method="post" id="mating-form" action="{{ url_for('pedigree.run_simulation', filename=filename) }}">
    <!-- Hidden inputs to store the final IDs for submission -->
    <div id="hidden-inputs"></div>

    <div class="selection-container">
        <!-- DAMS (FEMALES) COLUMN -->
        <div class="column">
            <h2>Nőstények (Dams)</h2>
            <label for="dam-farm-selector">Válasszon tenyészetet:</label>
            <select id="dam-farm-selector" class="farm-selector"></select>
            
            <label>Elérhető nőstények:</label>
            <select id="available-dams" class="animal-list" multiple></select>
        </div>

        <div class="controls">
            <button type="button" class="button" onclick="addAnimals('dam')">&rsaquo;&rsaquo; Hozzáad</button>
            <button type="button" class="button" onclick="removeAnimals('dam')">&lsaquo;&lsaquo; Eltávolít</button>
        </div>

        <div class="column">
            <h2>Kiválasztott Nőstények</h2>
            <table class="sortable-table" id="selected-dams-table">
                <thead>
                    <tr>
                        <th data-column="0">Egyed Azonosító (IBC)</th>
                        <th data-column="1">Tenyészet</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <hr style="margin: 2rem 0;">

    <div class="selection-container">
        <!-- SIRES (MALES) COLUMN -->
        <div class="column">
            <h2>Hímek (Sires)</h2>
            <label for="sire-farm-selector">Válasszon tenyészetet:</label>
            <select id="sire-farm-selector" class="farm-selector"></select>
            
            <label>Elérhető hímek:</label>
            <select id="available-sires" class="animal-list" multiple></select>
        </div>

        <div class="controls">
            <button type="button" class="button" onclick="addAnimals('sire')">&rsaquo;&rsaquo; Hozzáad</button>
            <button type="button" class="button" onclick="removeAnimals('sire')">&lsaquo;&lsaquo; Eltávolít</button>
        </div>

        <div class="column">
            <h2>Kiválasztott Hímek</h2>
            <table class="sortable-table" id="selected-sires-table">
                <thead>
                    <tr>
                        <th data-column="0">Egyed Azonosító (IBC)</th>
                        <th data-column="1">Tenyészet</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div class="main-actions">
        <button type="submit" class="action-button">Párosítási Szimuláció Indítása</button>
    </div>
</form>

<script>
    const allAnimals = {{ animals_json|safe }};
    const farms = {{ farms|tojson }};
    const animalMap = new Map(allAnimals.map(animal => [String(animal.animal_id), animal]));

    function populateSelectors() {
        const damFarmSelector = document.getElementById('dam-farm-selector');
        const sireFarmSelector = document.getElementById('sire-farm-selector');
        
        farms.forEach(farm => {
            damFarmSelector.add(new Option(farm, farm));
            sireFarmSelector.add(new Option(farm, farm));
        });

        damFarmSelector.addEventListener('change', () => updateAvailableAnimals('dam'));
        sireFarmSelector.addEventListener('change', () => updateAvailableAnimals('sire'));

        updateAvailableAnimals('dam');
        updateAvailableAnimals('sire');

        makeTableSortable('selected-dams-table');
        makeTableSortable('selected-sires-table');
    }

    function getSelectedIDs(type) {
        const table = document.getElementById(`selected-${type}s-table`);
        return new Set(Array.from(table.querySelectorAll('tbody tr')).map(row => row.dataset.animalId));
    }

    function updateAvailableAnimals(type) {
        const farmSelector = document.getElementById(`${type}-farm-selector`);
        const availableList = document.getElementById(`available-${type}s`);
        const selectedIDs = getSelectedIDs(type);
        const selectedFarm = farmSelector.value;
        const gender = (type === 'dam') ? 'F' : 'M';

        availableList.innerHTML = '';
        allAnimals
            .filter(animal => animal.farm_id === selectedFarm && animal.gender === gender && !selectedIDs.has(String(animal.animal_id)))
            .forEach(animal => {
                const label = `ID: ${animal.animal_id} (${animal.ibc.toFixed(4)})`;
                availableList.add(new Option(label, animal.animal_id));
            });
    }

    function addAnimals(type) {
        const availableList = document.getElementById(`available-${type}s`);
        const tableBody = document.getElementById(`selected-${type}s-table`).querySelector('tbody');
        
        Array.from(availableList.selectedOptions).forEach(option => {
            const animal = animalMap.get(option.value);
            if (animal) {
                const row = document.createElement('tr');
                row.dataset.animalId = animal.animal_id;
                const idCellText = `ID: ${animal.animal_id} (${animal.ibc.toFixed(4)})`;
                row.innerHTML = `<td>${idCellText}</td><td>${animal.farm_id}</td>`;
                row.addEventListener('click', () => row.classList.toggle('selected'));
                tableBody.appendChild(row);
            }
            option.remove();
        });
    }

    function removeAnimals(type) {
        const tableBody = document.getElementById(`selected-${type}s-table`).querySelector('tbody');
        const selectedRows = tableBody.querySelectorAll('tr.selected');
        
        selectedRows.forEach(row => row.remove());
        
        updateAvailableAnimals('dam');
        updateAvailableAnimals('sire');
    }
    
    document.getElementById('mating-form').addEventListener('submit', function(e) {
        const hiddenInputsContainer = document.getElementById('hidden-inputs');
        hiddenInputsContainer.innerHTML = ''; // Clear previous hidden inputs

        const damIDs = Array.from(document.querySelectorAll('#selected-dams-table tbody tr')).map(row => row.dataset.animalId);
        damIDs.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_dams';
            input.value = id;
            hiddenInputsContainer.appendChild(input);
        });

        const sireIDs = Array.from(document.querySelectorAll('#selected-sires-table tbody tr')).map(row => row.dataset.animalId);
        sireIDs.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_sires';
            input.value = id;
            hiddenInputsContainer.appendChild(input);
        });
    });

    function makeTableSortable(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const headers = table.querySelectorAll('th');
        const tbody = table.querySelector('tbody');
        let directions = Array.from(headers).map(() => '');

        headers.forEach((header, index) => {
            header.addEventListener('click', () => {
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const currentDirection = directions[index] || 'asc';
                const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                
                const sortedRows = rows.sort((a, b) => {
                    const cellA = a.children[index].textContent.trim();
                    const cellB = b.children[index].textContent.trim();
                    
                    let valA, valB;
                    if (index === 0) { // Special handling for the ID (IBC) column
                        valA = parseFloat(cellA.match(/ID: (\d+)/)[1]);
                        valB = parseFloat(cellB.match(/ID: (\d+)/)[1]);
                    } else {
                        valA = cellA;
                        valB = cellB;
                    }

                    if (valA < valB) return newDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return newDirection === 'asc' ? 1 : -1;
                    return 0;
                });

                tbody.innerHTML = '';
                sortedRows.forEach(row => tbody.appendChild(row));

                directions.fill('');
                directions[index] = newDirection;
            });
        });
    }

    document.addEventListener('DOMContentLoaded', populateSelectors);
</script>
{% endblock %}

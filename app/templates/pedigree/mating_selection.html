{% extends 'base.html' %}
{% block title %}Párosítási kiválasztás - OptiBreed{% endblock %}

{% block content %}
<style>
    :root {
        --selected-row-bg: #BEE1F8; /* Softer, more harmonious blue */
    }
    .mating-container { display: flex; flex-direction: column; gap: 3rem; }
    .selector-section { border: 1px solid #ccc; border-radius: var(--border-radius); padding: 1.5rem; background-color: #fff; }
    .selector-section h2 { margin-top: 0; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-color); }
    .selector-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: center; }
    .grid-panel { border: 1px solid #ddd; border-radius: var(--border-radius); overflow: hidden; display: flex; flex-direction: column; }
    .grid-header { padding: 0.5rem 1rem; background-color: #f7f7f7; display: flex; align-items: center; gap: 0.5rem; font-weight: bold; color: #333; }
    .farm-filter { flex-grow: 1; }
    .farm-filter select { width: 100%; padding: 8px; border-radius: var(--border-radius); border: 1px solid #ccc; }
    .animal-grid { height: 300px; overflow-y: auto; }
    .transfer-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
    .transfer-buttons button { padding: 10px; cursor: pointer; border-radius: var(--border-radius); background-color: var(--secondary-color); color: white; border: none; font-size: 1.2rem; line-height: 1; }
    .transfer-buttons button:hover { background-color: var(--primary-color); }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #f2f2f2; cursor: pointer; position: sticky; top: 0; user-select: none; }
    th:hover { background-color: #e9e9e9; }
    th .sort-indicator { display: inline-block; width: 1em; text-align: left; }
    th.sort-asc .sort-indicator::after { content: ' ▲'; }
    th.sort-desc .sort-indicator::after { content: ' ▼'; }
    tr.selected-row { background-color: var(--selected-row-bg); }
    tbody tr { cursor: pointer; }
    /* Only disable pointer events on checkboxes in the table body, not the header */
    tbody input[type="checkbox"] { pointer-events: none; }

    #export-button { margin-top: 2rem; }
</style>

<div class="container">
    <h1>Párosítási kiválasztás</h1>
    <p>Válassza ki a tenyészállatokat a szimulációhoz. Bal oldalon láthatók a farm szerint szűrt, elérhető állatok. Jobb oldalon a párosításhoz kiválasztott állatok listája.</p>

    <div class="mating-container">
        <!-- Dams Section -->
        <div class="selector-section">
            <h2>Anyák (nőstények) kiválasztása</h2>
            <div class="selector-grid">
                <div class="grid-panel">
                    <div class="grid-header">
                        <label for="dam-farm-filter">Tenyészet:</label>
                        <div class="farm-filter"><select id="dam-farm-filter"></select></div>
                    </div>
                    <div class="animal-grid"><table id="dam-available-grid"></table></div>
                </div>
                <div class="transfer-buttons">
                    <button id="add-dam-btn" title="Kiválasztottak hozzáadása">&gt;&gt;</button>
                    <button id="remove-dam-btn" title="Kiválasztottak eltávolítása">&lt;&lt;</button>
                </div>
                <div class="grid-panel">
                    <div class="grid-header">Kiválasztott anyák</div>
                    <div class="animal-grid"><table id="dam-selected-grid"></table></div>
                </div>
            </div>
        </div>

        <!-- Sires Section -->
        <div class="selector-section">
            <h2>Apák (hímek) kiválasztása</h2>
            <div class="selector-grid">
                <div class="grid-panel">
                    <div class="grid-header">
                        <label for="sire-farm-filter">Tenyészet:</label>
                        <div class="farm-filter"><select id="sire-farm-filter"></select></div>
                    </div>
                    <div class="animal-grid"><table id="sire-available-grid"></table></div>
                </div>
                <div class="transfer-buttons">
                    <button id="add-sire-btn" title="Kiválasztottak hozzáadása">&gt;&gt;</button>
                    <button id="remove-sire-btn" title="Kiválasztottak eltávolítása">&lt;&lt;</button>
                </div>
                <div class="grid-panel">
                    <div class="grid-header">Kiválasztott apák</div>
                    <div class="animal-grid"><table id="sire-selected-grid"></table></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Form -->
    <form id="export-form" method="POST" action="{{ url_for('main.export_results') }}">
        <input type="hidden" name="session_id" value="{{ session_id }}">
        <input type="hidden" id="sire_ids" name="sire_ids">
        <input type="hidden" id="dam_ids" name="dam_ids">
        <button type="submit" id="export-button" class="button">Szimuláció és exportálás excelbe</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SESSION_ID = "{{ session_id }}";
    
    let allSires = [], allDams = [], selectedSires = [], selectedDams = [];

    async function initialize() {
        const data = await fetchAnimals();
        if (!data) return;
        
        allSires = data.sires;
        allDams = data.dams;

        setupSelector('dam', allDams, selectedDams);
        setupSelector('sire', allSires, selectedSires);
    }

    async function fetchAnimals() {
        try {
            const response = await fetch(`/pedigree/animals/${SESSION_ID}`);
            if (!response.ok) throw new Error(`Szerverhiba: ${response.statusText}`);
            return await response.json();
        } catch (error) {
            console.error("Hiba az állatok lekérésekor:", error);
            alert("Hiba történt az állatok adatainak lekérése közben. Kérjük, próbálja meg később.");
            return null;
        }
    }

    function setupSelector(type, allAnimals, selectedAnimals) {
        const farmFilter = document.getElementById(`${type}-farm-filter`);
        const availableGrid = document.getElementById(`${type}-available-grid`);
        const selectedGrid = document.getElementById(`${type}-selected-grid`);
        const addBtn = document.getElementById(`add-${type}-btn`);
        const removeBtn = document.getElementById(`remove-${type}-btn`);

        const farms = ['Minden', ...[...new Set(allAnimals.map(a => a.farm))].sort()];
        farmFilter.innerHTML = farms.map(f => `<option value="${f}">${f}</option>`).join('');

        const renderGrids = () => {
            const selectedFarm = farmFilter.value;
            const available = allAnimals.filter(animal => 
                !selectedAnimals.some(sa => sa.animal_id === animal.animal_id) &&
                (selectedFarm === 'Minden' || animal.farm === selectedFarm)
            );
            renderTable(availableGrid, available);
            renderTable(selectedGrid, selectedAnimals);
        };

        const transferAnimals = (direction) => {
            const sourceGrid = direction === 'add' ? availableGrid : selectedGrid;
            const checkedRows = Array.from(sourceGrid.querySelectorAll('.row-select:checked'));
            const idsToTransfer = new Set(checkedRows.map(cb => parseInt(cb.closest('tr').dataset.id, 10)));

            if (direction === 'add') {
                const animalsToAdd = allAnimals.filter(a => idsToTransfer.has(a.animal_id));
                selectedAnimals.push(...animalsToAdd);
            } else { // 'remove'
                // Modify the array in-place to maintain the reference across scopes.
                for (let i = selectedAnimals.length - 1; i >= 0; i--) {
                    if (idsToTransfer.has(selectedAnimals[i].animal_id)) {
                        selectedAnimals.splice(i, 1);
                    }
                }
            }
            renderGrids();
            updateExportForm();
        };

        farmFilter.addEventListener('change', renderGrids);
        addBtn.addEventListener('click', () => transferAnimals('add'));
        removeBtn.addEventListener('click', () => transferAnimals('remove'));

        function renderTable(tableEl, animals) {
            tableEl.sortState = tableEl.sortState || {};
            if (tableEl.sortState.column) {
                const { column, direction } = tableEl.sortState;
                animals.sort((a, b) => {
                    const valA = a[column], valB = b[column];
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const headers = [
                { key: 'animal_id', label: 'Azonosító' },
                { key: 'farm', label: 'Tenyészet' },
                { key: 'ibc', label: 'IBC' }
            ];
            
            tableEl.innerHTML = `<thead><tr><th><input type="checkbox" class="select-all"></th>${headers.map(h => `<th data-sort-key="${h.key}">${h.label} <span class="sort-indicator"></span></th>`).join('')}</tr></thead><tbody>${animals.map(animal => `
                <tr data-id="${animal.animal_id}">
                    <td><input type="checkbox" class="row-select"></td>
                    <td>${animal.animal_id}</td>
                    <td>${animal.farm}</td>
                    <td>${animal.ibc.toFixed(4)}</td>
                </tr>`).join('')}</tbody>`;

            // --- Event Listeners ---
            const tbody = tableEl.querySelector('tbody');
            if (!tbody) return;
            tbody.lastSelectedRowIndex = -1;

            tbody.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                const row = e.target.closest('tr');
                if (!row) return;

                const rowIndex = Array.from(tbody.children).indexOf(row);
                const checkbox = row.querySelector('.row-select');
                const allRows = Array.from(tbody.children);

                if (e.shiftKey && tbody.lastSelectedRowIndex > -1) {
                    const start = Math.min(rowIndex, tbody.lastSelectedRowIndex);
                    const end = Math.max(rowIndex, tbody.lastSelectedRowIndex);
                    allRows.forEach((r, i) => {
                        const cb = r.querySelector('.row-select');
                        if (i >= start && i <= end) {
                            cb.checked = true;
                            r.classList.add('selected-row');
                        } else if (!e.ctrlKey) {
                            cb.checked = false;
                            r.classList.remove('selected-row');
                        }
                    });
                } else if (e.ctrlKey) {
                    checkbox.checked = !checkbox.checked;
                    row.classList.toggle('selected-row', checkbox.checked);
                } else {
                    const isCurrentlySelected = checkbox.checked && row.classList.contains('selected-row');
                    const isOnlyOneSelected = allRows.filter(r => r.querySelector('.row-select').checked).length === 1;

                    allRows.forEach(r => {
                        r.querySelector('.row-select').checked = false;
                        r.classList.remove('selected-row');
                    });
                    
                    if (!isCurrentlySelected || !isOnlyOneSelected) {
                        checkbox.checked = true;
                        row.classList.add('selected-row');
                    }
                }
                tbody.lastSelectedRowIndex = rowIndex;
            });

            tableEl.querySelector('.select-all').addEventListener('click', (e) => {
                const isChecked = e.target.checked;
                tbody.querySelectorAll('tr').forEach(row => {
                    row.querySelector('.row-select').checked = isChecked;
                    row.classList.toggle('selected-row', isChecked);
                });
            });

            tableEl.querySelectorAll('th[data-sort-key]').forEach(th => {
                const key = th.dataset.sortKey;
                if (tableEl.sortState.column === key) {
                    th.classList.add(tableEl.sortState.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }

                th.addEventListener('click', () => {
                    const currentDir = tableEl.sortState.direction;
                    let newDir = 'asc';
                    if (tableEl.sortState.column === key && currentDir === 'asc') {
                        newDir = 'desc';
                    }
                    tableEl.sortState = { column: key, direction: newDir };
                    renderGrids(); // Just re-render the grids with the new sort state
                });
            });
        }
        renderGrids();
    }

    function updateExportForm() {
        document.getElementById('sire_ids').value = selectedSires.map(a => a.animal_id).join(',');
        document.getElementById('dam_ids').value = selectedDams.map(a => a.animal_id).join(',');
    }

    initialize();
});
</script>
{% endblock %}

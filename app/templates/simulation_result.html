{% extends 'base.html' %}
{% block title %}Szimulációs Eredmények - OptiBreed{% endblock %}

{% block content %}
<style>
    :root {
        --lowest-ibc-bg: #d4edda; /* Pastel light green for highlighting */
    }
    #results-table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
    #results-table th, #results-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    #results-table thead { background-color: #f2f2f2; position: sticky; top: 0; }
    .sortable-header { cursor: pointer; position: relative; user-select: none; }
    .sortable-header .sort-indicator { display: inline-block; width: 1em; text-align: left; }
    .sortable-header.sort-asc .sort-indicator::after { content: ' ▲'; }
    .sortable-header.sort-desc .sort-indicator::after { content: ' ▼'; }
    .lowest-ibc { background-color: var(--lowest-ibc-bg); }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: var(--border-radius); }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    
    #modal-dam-table { margin-top: 1rem; max-height: 400px; overflow-y: auto; width: 100%; border-collapse: collapse; }
    #modal-dam-table th, #modal-dam-table td { border-bottom: 1px solid #ddd; padding: 8px; }
    #modal-dam-table thead { background-color: #f9f9f9; }

    #export-container { margin-top: 2rem; text-align: right; }
</style>

<div class="container">
    <h1>Szimulációs Eredmények</h1>
    <p>A táblázat a kiválasztott apák és anyák lehetséges párosításainak összesített eredményeit mutatja. Kattintson a "Részletek" gombra egy apa összes párosításának megtekintéséhez.</p>

    <table id="results-table">
        <thead>
            <tr>
                <th class="sortable-header" data-sort-key="sire_id">Apa Azonosító</th>
                <th class="sortable-header" data-sort-key="sire_farm">Apa Tenyészet</th>
                <th class="sortable-header" data-sort-key="sire_ibc">Apa BTE</th>
                <th class="sortable-header" data-sort-key="avg_offspring_ibc">Várható Utód BTE (Átlag)</th>
                <th>Művelet</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically inserted here -->
        </tbody>
    </table>

    <!-- The Modal -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Párosítás Részletei</h2>
            <div id="modal-sire-details"></div>
            <hr>
            <h3>Lehetséges párosítások az alábbi anyákkal:</h3>
            <div id="modal-dam-list-container">
                <table id="modal-dam-table">
                    <thead>
                        <tr>
                            <th>Anya Azonosító</th>
                            <th>Anya Tenyészet</th>
                            <th>Anya BTE</th>
                            <th>Várható Utód BTE</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const pairings = {{ results|tojson }};
    const tableBody = document.querySelector('#results-table tbody');
    const modal = document.getElementById('details-modal');
    const closeButton = document.querySelector('.close-button');
    let sireSummaryData = [];

    function processData() {
        const sires = {};
        if (!pairings || pairings.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nincsenek eredmények a megjelenítéshez.</td></tr>';
            return;
        }

        pairings.forEach(p => {
            if (!sires[p.sire_id]) {
                sires[p.sire_id] = {
                    sire_id: p.sire_id,
                    sire_farm: p.sire_farm,
                    sire_ibc: p.sire_ibc,
                    pairings: [],
                    total_offspring_ibc: 0
                };
            }
            sires[p.sire_id].pairings.push(p);
            sires[p.sire_id].total_offspring_ibc += p.offspring_ibc;
        });

        sireSummaryData = Object.values(sires).map(s => ({
            ...s,
            avg_offspring_ibc: s.total_offspring_ibc / s.pairings.length
        }));

        renderTable(sireSummaryData);
    }

    function renderTable(data) {
        tableBody.innerHTML = '';
        data.forEach(sire => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sire.sire_id}</td>
                <td>${sire.sire_farm}</td>
                <td>${sire.sire_ibc.toFixed(4)}</td>
                <td>${sire.avg_offspring_ibc.toFixed(4)}</td>
                <td><button class="button details-btn" data-sire-id="${sire.sire_id}">Részletek...</button></td>
            `;
            tableBody.appendChild(row);
        });
        highlightLowestAverage();
    }

    function highlightLowestAverage() {
        let lowestAvg = Infinity;
        let lowestRow = null;

        tableBody.querySelectorAll('tr').forEach((row, index) => {
            const avgIbc = sireSummaryData[index]?.avg_offspring_ibc;
            if (avgIbc < lowestAvg) {
                lowestAvg = avgIbc;
                if(lowestRow) lowestRow.classList.remove('lowest-ibc');
                lowestRow = row;
                row.classList.add('lowest-ibc');
            } else {
                row.classList.remove('lowest-ibc');
            }
        });
    }

    function sortTable(key) {
        const header = document.querySelector(`.sortable-header[data-sort-key='${key}']`);
        const direction = header.classList.contains('sort-asc') ? 'desc' : 'asc';

        sireSummaryData.sort((a, b) => {
            if (a[key] < b[key]) return direction === 'asc' ? -1 : 1;
            if (a[key] > b[key]) return direction === 'asc' ? 1 : -1;
            return 0;
        });

        document.querySelectorAll('.sortable-header').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
        header.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');

        renderTable(sireSummaryData);
    }

    function showModal(sireId) {
        const sireData = sireSummaryData.find(s => s.sire_id === sireId);
        if (!sireData) return;

        document.getElementById('modal-sire-details').innerHTML = `
            <strong>Apa Azonosító:</strong> ${sireData.sire_id}<br>
            <strong>Tenyészet:</strong> ${sireData.sire_farm}<br>
            <strong>BTE:</strong> ${sireData.sire_ibc.toFixed(4)}
        `;

        const modalTbody = document.querySelector('#modal-dam-table tbody');
        modalTbody.innerHTML = sireData.pairings.map(p => `
            <tr>
                <td>${p.dam_id}</td>
                <td>${p.dam_farm}</td>
                <td>${p.dam_ibc.toFixed(4)}</td>
                <td>${p.offspring_ibc.toFixed(4)}</td>
            </tr>
        `).join('');

        modal.style.display = 'block';
    }

    // Event Listeners
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', () => sortTable(header.dataset.sortKey));
    });

    tableBody.addEventListener('click', e => {
        if (e.target.classList.contains('details-btn')) {
            const sireId = parseInt(e.target.dataset.sireId, 10);
            showModal(sireId);
        }
    });

    closeButton.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', e => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Initial Load
    processData();
});
</script>
{% endblock %}
